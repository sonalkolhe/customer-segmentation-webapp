<!doctype html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Customer Segmentation Tool | Segmently</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;800&display=swap" rel="stylesheet">
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
</head>

<body>

    <nav class="navbar navbar-expand-lg fixed-top">
        <div class="container">
            <a class="navbar-brand" href="#">
                <i class="bi bi-pie-chart-fill text-primary me-2"></i>Segmently
            </a>
            <div class="ms-auto">
                <a class="btn btn-sm btn-outline-secondary" href="#">Sign In</a>
            </div>
        </div>
    </nav>

    <div class="hero-section">
        <div class="container" style="position: relative; z-index: 5;">
            <h1 class="hero-title">Unlock Hidden Customer Insights</h1>
            <p class="hero-subtitle">
                Upload your customer data and let our AI-powered clustering engine identify hidden patterns, 
                helping you target the right audience with the right strategy.
            </p>

            {% with messages = get_flashed_messages() %}
              {% if messages %}
                <div class="alert alert-danger mx-auto" role="alert" style="max-width: 800px;">
                  {{ messages[0] }}
                </div>
              {% endif %}
            {% endwith %}

            <div class="tool-card">
                <div class="d-flex justify-content-between align-items-center mb-4 flex-wrap gap-2">
                    <h4 class="mb-0 fw-bold">Analyze Data</h4>
                    <button type="button" class="btn btn-sm btn-outline-secondary" id="downloadTemplateBtn">
                        <i class="bi bi-download me-2"></i>Download Template
                    </button>
                </div>

                <form action="/analyze" method="POST" enctype="multipart/form-data" id="uploadForm">
                    <div id="dropzone" class="drop-zone">
                        <i class="bi bi-cloud-arrow-up text-primary" style="font-size: 48px;"></i>
                        <h5 class="fw-bold mt-3">Drag & Drop your CSV here</h5>
                        <p class="text-muted mb-0">or click to browse files</p>
                        <input id="fileInput" name="file" type="file" accept=".csv,text/csv" style="display: none;" />
                    </div>

                    <div class="d-grid gap-2 mt-4">
                        <button type="submit" class="btn btn-primary-custom" id="submitBtn" disabled>
                            Run Segmentation Analysis
                        </button>
                    </div>
                </form>

                <p class="text-muted text-center mt-3 small">
                    <i class="bi bi-lock-fill me-1"></i>Your data is processed securely.
                </p>
            </div>
        </div>

        <div class="wave-divider">
            <svg data-name="Layer 1" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1200 120" preserveAspectRatio="none">
                <path d="M321.39,56.44c58-10.79,114.16-30.13,172-41.86,82.39-16.72,168.19-17.73,250.45-.39C823.78,31,906.67,72,985.66,92.83c70.05,18.48,146.53,26.09,214.34,3V0H0V27.35A600.21,600.21,0,0,0,321.39,56.44Z" class="wave-fill-white"></path>
            </svg>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        const dropZone = document.getElementById("dropzone");
        const fileInput = document.getElementById("fileInput");
        const submitBtn = document.getElementById("submitBtn");
        const downloadBtn = document.getElementById("downloadTemplateBtn");
        const uploadForm = document.getElementById("uploadForm");

        // Template Generator
        function makeTemplateCSV() {
            return "CustomerID,Gender,Age,Annual Income (k$),Spending Score (1-100)\n001,Male,19,15,39\n002,Male,21,15,81";
        }

        downloadBtn.addEventListener("click", () => {
            const link = document.createElement('a');
            link.href = 'data:text/csv;charset=utf-8,' + encodeURIComponent(makeTemplateCSV());
            link.download = 'customer_segmentation_template.csv';
            link.click();
        });

        // Click to browse
        dropZone.addEventListener("click", () => fileInput.click());

        fileInput.addEventListener("change", (e) => {
            if (e.target.files.length > 0) handleFiles(e.target.files);
        });

        // Drag & Drop events
        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
            dropZone.addEventListener(eventName, (e) => {
                e.preventDefault();
                e.stopPropagation();
            }, false);
        });

        ['dragenter', 'dragover'].forEach(eventName => {
            dropZone.addEventListener(eventName, () => dropZone.classList.add('dragover'), false);
        });

        ['dragleave', 'drop'].forEach(eventName => {
            dropZone.addEventListener(eventName, () => dropZone.classList.remove('dragover'), false);
        });

        dropZone.addEventListener('drop', (e) => {
            const files = e.dataTransfer.files;
            fileInput.files = files; // Assign dropped files to input
            handleFiles(files);
        });

        function handleFiles(files) {
            const file = files[0];
            if (!file) return;

            if (!file.name.toLowerCase().endsWith(".csv")) {
                alert("Please upload a valid .csv file.");
                return;
            }

            // Visual feedback
            dropZone.innerHTML = `
                <i class="bi bi-file-earmark-spreadsheet-fill text-success" style="font-size: 48px;"></i>
                <h5 class="fw-bold mt-2">${file.name}</h5>
                <p class="text-success mb-0">Ready to Analyze</p>
                <input id="fileInput" name="file" type="file" accept=".csv,text/csv" style="display: none;" />
            `;
            
            // Re-assign file object to the new input element in DOM
            const newInput = document.getElementById('fileInput');
            const dataTransfer = new DataTransfer();
            dataTransfer.items.add(file);
            newInput.files = dataTransfer.files;

            submitBtn.disabled = false;
        }

        uploadForm.addEventListener("submit", function() {
            submitBtn.disabled = true;
            submitBtn.innerHTML = `<span class="spinner-border spinner-border-sm me-2"></span>Processing...`;
        });
    </script>
</body>
</html>