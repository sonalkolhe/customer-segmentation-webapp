<!doctype html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Analysis Results | Segmently</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;800&display=swap" rel="stylesheet">
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">

    <style>
        :root {
            --primary-color: #4f46e5;
            --primary-hover: #4338ca;
            --text-dark: #1e293b;
            --text-muted: #64748b;
            --bg-color: #f8fafc;
            --card-border: #e2e8f0;
        }

        body {
            background-color: var(--bg-color);
            color: var(--text-dark);
            font-family: 'Inter', sans-serif;
            -webkit-font-smoothing: antialiased;
            padding-top: 80px; /* For fixed navbar */
        }

        /* Navbar */
        .navbar {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            box-shadow: 0 1px 2px rgba(0,0,0,0.03);
        }
        .navbar-brand {
            font-weight: 700;
            color: var(--text-dark);
            letter-spacing: -0.5px;
        }

        /* Result Header */
        .results-header {
            background: white;
            padding: 40px 0;
            border-bottom: 1px solid var(--card-border);
            margin-bottom: 40px;
        }

        /* Tabs Styling */
        .nav-pills .nav-link {
            color: var(--text-muted);
            font-weight: 600;
            padding: 10px 24px;
            border-radius: 8px;
            margin-right: 10px;
            transition: all 0.2s;
        }
        .nav-pills .nav-link.active {
            background-color: var(--primary-color);
            color: white;
            box-shadow: 0 4px 12px rgba(79, 70, 229, 0.3);
        }
        .nav-pills .nav-link:hover:not(.active) {
            background-color: #eef2ff;
            color: var(--primary-color);
        }

        /* Graph Card */
        .graph-card {
            background: white;
            border-radius: 16px;
            padding: 20px;
            border: 1px solid var(--card-border);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.02);
            height: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }
        
        .graph-img {
            max-width: 100%;
            height: auto;
            border-radius: 8px;
        }

        /* Insight/Cluster Cards */
        .cluster-card {
            background: white;
            border-radius: 12px;
            padding: 24px;
            border: 1px solid var(--card-border);
            border-left: 5px solid var(--primary-color); /* Accent border */
            transition: transform 0.2s;
            height: 100%;
        }
        .cluster-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.05);
        }

        .stat-label {
            font-size: 0.8rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: var(--text-muted);
            margin-bottom: 4px;
        }
        .stat-value {
            font-size: 1.25rem;
            font-weight: 700;
            color: var(--text-dark);
        }
        
        .cluster-badge {
            background-color: #eef2ff;
            color: var(--primary-color);
            padding: 4px 12px;
            border-radius: 50px;
            font-size: 0.85rem;
            font-weight: 600;
        }

        /* Buttons */
        .btn-download {
            background-color: white;
            color: var(--text-dark);
            border: 1px solid var(--card-border);
            font-weight: 600;
            padding: 10px 20px;
            border-radius: 8px;
            transition: all 0.2s;
        }
        .btn-download:hover {
            background-color: #f8fafc;
            border-color: var(--text-muted);
        }

        /* Placeholder for loading */
        .loading-placeholder {
            height: 400px;
            background-color: #f1f5f9;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--text-muted);
        }
    </style>
</head>

<body>

    <nav class="navbar navbar-expand-lg fixed-top">
        <div class="container">
            <a class="navbar-brand" href="index.html">
                <i class="bi bi-pie-chart-fill text-primary me-2"></i>Segmently
            </a>
            <div class="ms-auto">
                <a href="index.html" class="btn btn-sm btn-outline-secondary">New Analysis</a>
            </div>
        </div>
    </nav>

    <section class="results-header">
        <div class="container">
            <div class="row align-items-center">
                <div class="col-md-8">
                    <h2 class="fw-bold mb-2">Segmentation Results</h2>
                    <p class="text-muted mb-0">Analysis based on your uploaded CSV data. We found distinct customer groups.</p>
                </div>
                <div class="col-md-4 text-md-end mt-3 mt-md-0">
                    <ul class="nav nav-pills justify-content-md-end" id="pills-tab" role="tablist">
                        <li class="nav-item" role="presentation">
                            <button class="nav-link active" id="pills-income-tab" data-bs-toggle="pill" data-bs-target="#pills-income" type="button" role="tab">Income Analysis</button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="pills-age-tab" data-bs-toggle="pill" data-bs-target="#pills-age" type="button" role="tab">Age Analysis</button>
                        </li>
                    </ul>
                </div>
            </div>
        </div>
    </section>

    <div class="container pb-5">
        <div class="tab-content" id="pills-tabContent">
            
            <div class="tab-pane fade show active" id="pills-income" role="tabpanel">
                <div class="row g-4">
                    <div class="col-lg-7">
                        <div class="graph-card">
                            <h5 class="fw-bold mb-4">Income vs. Spending Clusters</h5>
                            <img id="income-plot-img" src="" alt="Income Segmentation Graph" class="graph-img d-none">
                            <div id="income-loading" class="loading-placeholder w-100">
                                <div class="text-center">
                                    <div class="spinner-border text-primary mb-3" role="status"></div>
                                    <p>Loading Data...</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="col-lg-5">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <h5 class="fw-bold m-0">Cluster Insights</h5>
                            <a id="income-download-btn" href="#" class="btn btn-sm btn-download">
                                <i class="bi bi-download me-2"></i>Download CSV
                            </a>
                        </div>
                        
                        <div id="income-insights-container" class="d-flex flex-column gap-3">
                            </div>
                    </div>
                </div>
            </div>

            <div class="tab-pane fade" id="pills-age" role="tabpanel">
                <div class="row g-4">
                    <div class="col-lg-7">
                        <div class="graph-card">
                            <h5 class="fw-bold mb-4">Age vs. Spending Clusters</h5>
                            <img id="age-plot-img" src="" alt="Age Segmentation Graph" class="graph-img d-none">
                            <div id="age-loading" class="loading-placeholder w-100">
                                <div class="text-center">
                                    <div class="spinner-border text-primary mb-3" role="status"></div>
                                    <p>Loading Data...</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="col-lg-5">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <h5 class="fw-bold m-0">Cluster Insights</h5>
                            <a id="age-download-btn" href="#" class="btn btn-sm btn-download">
                                <i class="bi bi-download me-2"></i>Download CSV
                            </a>
                        </div>
                        
                         <div id="age-insights-container" class="d-flex flex-column gap-3">
                            </div>
                    </div>
                </div>
            </div>

        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <script>
        document.addEventListener("DOMContentLoaded", () => {
            // 1. Retrieve Data from Session Storage
            const storedData = sessionStorage.getItem('segmentationResults');

            if (!storedData) {
                // If no data is found (user accessed result.html directly), redirect to home
                alert("No analysis data found. Redirecting to upload page.");
                window.location.href = 'index.html';
                return;
            }

            try {
                const results = JSON.parse(storedData);
                
                // 2. Render Both Tabs
                if (results.income) renderIncomeTab(results.income);
                if (results.age) renderAgeTab(results.age);

            } catch (error) {
                console.error("Error parsing results:", error);
                alert("Error loading results data.");
            }
        });

        function renderIncomeTab(data) {
            // A. Render Image (Base64)
            const imgEl = document.getElementById('income-plot-img');
            const loadingEl = document.getElementById('income-loading');
            
            // Backend sends raw base64, we need to add the prefix
            imgEl.src = "data:image/png;base64," + data.plot_base64;
            
            imgEl.onload = () => {
                imgEl.classList.remove('d-none');
                loadingEl.classList.add('d-none');
            };

            // B. Set Download Link
            // Note: Ensure your Flask app has a route to serve files from /downloads/
            document.getElementById('income-download-btn').href = data.csv_url;

            // C. Generate Insight Cards
            const container = document.getElementById('income-insights-container');
            container.innerHTML = ""; // Clear existing

            // Data.insights is an object like { "0": {...}, "1": {...} }
            Object.keys(data.insights).forEach(clusterId => {
                const stats = data.insights[clusterId];
                
                // Keys match exactly what is returned from model.py
                const cardHtml = `
                    <div class="cluster-card">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <span class="cluster-badge">Cluster ${clusterId}</span>
                            <small class="text-muted"><i class="bi bi-people-fill me-1"></i> ${stats.Size || 'N/A'} Customers</small>
                        </div>
                        <div class="row text-center">
                            <div class="col-4 border-end">
                                <div class="stat-label">Avg Income</div>
                                <div class="stat-value text-success">$${Math.round(stats['Annual Income (k$)'])}k</div>
                            </div>
                            <div class="col-4 border-end">
                                <div class="stat-label">Avg Spend</div>
                                <div class="stat-value text-primary">${Math.round(stats['Spending Score (1-100)'])}</div>
                            </div>
                            <div class="col-4">
                                <div class="stat-label">Avg Age</div>
                                <div class="stat-value">${Math.round(stats['Age'])}</div>
                            </div>
                        </div>
                    </div>
                `;
                container.innerHTML += cardHtml;
            });
        }

        function renderAgeTab(data) {
            // A. Render Image
            const imgEl = document.getElementById('age-plot-img');
            const loadingEl = document.getElementById('age-loading');
            
            imgEl.src = "data:image/png;base64," + data.plot_base64;
            
            imgEl.onload = () => {
                imgEl.classList.remove('d-none');
                loadingEl.classList.add('d-none');
            };

            // B. Set Download Link
            document.getElementById('age-download-btn').href = data.csv_url;

            // C. Generate Insight Cards
            const container = document.getElementById('age-insights-container');
            container.innerHTML = ""; 

            Object.keys(data.insights).forEach(clusterId => {
                const stats = data.insights[clusterId];
                
                // Using different accent color (Orange) for Age Analysis
                const cardHtml = `
                    <div class="cluster-card" style="border-left-color: #ea580c;">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <span class="cluster-badge" style="color: #ea580c; background-color: #fff7ed;">Cluster ${clusterId}</span>
                            <small class="text-muted"><i class="bi bi-people-fill me-1"></i> ${stats.Size || 'N/A'} Customers</small>
                        </div>
                        <div class="row text-center">
                            <div class="col-4 border-end">
                                <div class="stat-label">Avg Age</div>
                                <div class="stat-value text-dark">${Math.round(stats['Age'])}</div>
                            </div>
                            <div class="col-4 border-end">
                                <div class="stat-label">Avg Spend</div>
                                <div class="stat-value text-primary">${Math.round(stats['Spending Score (1-100)'])}</div>
                            </div>
                            <div class="col-4">
                                <div class="stat-label">Avg Income</div>
                                <div class="stat-value text-muted">$${Math.round(stats['Annual Income (k$)'])}k</div>
                            </div>
                        </div>
                    </div>
                `;
                container.innerHTML += cardHtml;
            });
        }
    </script>
</body>
</html>